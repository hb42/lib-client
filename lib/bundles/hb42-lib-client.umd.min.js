!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/common"),require("@angular/common/http"),require("@angular/core"),require("@angular/router"),require("@hb42/lib-common"),require("rxjs"),require("rxjs/operators"),require("semver")):"function"==typeof define&&define.amd?define("@hb42/lib-client",["exports","@angular/common","@angular/common/http","@angular/core","@angular/router","@hb42/lib-common","rxjs","rxjs/operators","semver"],t):t(((e=e||self).hb42=e.hb42||{},e.hb42["lib-client"]={}),e.ng.common,e.ng.common.http,e.ng.core,e.ng.router,e.libCommon,e.rxjs,e.rxjs.operators,e.semver)}(this,(function(e,t,r,n,o,i,s,c,u){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation. All rights reserved.
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use
    this file except in compliance with the License. You may obtain a copy of the
    License at http://www.apache.org/licenses/LICENSE-2.0

    THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
    WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
    MERCHANTABLITY OR NON-INFRINGEMENT.

    See the Apache Version 2.0 License for specific language governing permissions
    and limitations under the License.
    ***************************************************************************** */function a(e,t,r,n){var o,i=arguments.length,s=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(o=e[c])&&(s=(i<3?o(s):i>3?o(t,r,s):o(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s}function l(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{u(n.next(e))}catch(e){i(e)}}function c(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new r((function(t){t(e.value)})).then(s,c)}u((n=n.apply(e,t||[])).next())}))}function p(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}var h=function(){function e(e){this.el=e,this.storageId="",this.lastPos=0,console.debug("c'tor flexboxsplitter"),this.splitter=e.nativeElement}var t;return t=e,e.prototype.ngOnInit=function(){this.prevEl=this.splitter.previousElementSibling,this.nextEl=this.splitter.nextElementSibling;var e=this.splitter.parentElement;"row"===this.getProp(e,"flexDirection")?(this.dimension="width",this.splitter.style["border-left"]="1px solid gray",this.splitter.style.cursor="col-resize"):(this.dimension="height",this.splitter.style["border-top"]="1px solid gray",this.splitter.style.cursor="row-resize"),this.splitter.style.background="#eee",this.splitter.style[this.dimension]="6px",this.initSplitter()},e.prototype.getProp=function(e,t){return window.getComputedStyle(e)[t]},e.prototype.initSplitter=function(){var e=this,r={bubbles:!1,cancelable:!1,detail:void 0};this.splitterEvent=document.createEvent("CustomEvent"),this.splitterEvent.initCustomEvent(t.SPLITTER_EVENT,r.bubbles,r.cancelable,r.detail);var n=function(t){"width"===e.dimension?o(t.clientX):o(t.clientY)},o=function(t){var r,n=t-e.lastPos;r=parseInt(e.getProp(e.prevEl,e.dimension),10)+n,e.prevEl.style[e.dimension]=r+"px",r=parseInt(e.getProp(e.nextEl,e.dimension),10)-n,e.nextEl.style[e.dimension]=r+"px",e.lastPos=t},i=function(){window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",i),window.dispatchEvent(e.splitterEvent),e.storageId&&localStorage.setItem(e.storageId,e.lastPos.toString(10))};if(this.splitter.addEventListener("mousedown",(function(t){t.preventDefault(),e.lastPos="width"===e.dimension?t.clientX:t.clientY,window.addEventListener("mousemove",n),window.addEventListener("mouseup",i)})),this.lastPos="width"===this.dimension?this.splitter.getBoundingClientRect().left:this.splitter.getBoundingClientRect().top,this.storageId){var s=localStorage.getItem(this.storageId),c=parseInt(s||"0",10);c&&o(c)}},e.SPLITTER_EVENT="hbsplitter",e.ctorParameters=function(){return[{type:n.ElementRef}]},a([n.Input()],e.prototype,"storageId",void 0),e=t=a([n.Directive({selector:"[fb-splitter]"})],e)}(),d=function(){function e(){this.suffix=["Bytes","kB","MB","GB","TB","PB","EB","ZB","YB"]}return e.prototype.transform=function(e){var t=Number(e);return this.conv(t,0)},e.prototype.conv=function(e,t){return e<1024?e+" "+this.suffix[t]:this.conv(Math.round(e/1024),++t)},e=a([n.Pipe({name:"filesize"})],e)}(),f=function(){function e(){}return e.prototype.transform=function(e){var t=new Date(e);return t.toLocaleDateString("de",{day:"2-digit",month:"2-digit",year:"numeric"})+" "+t.toLocaleTimeString()},e=a([n.Pipe({name:"iedate"})],e)}(),g=function(){function e(){var e=window;if("function"==typeof e.require){var t=e.require("electron");t&&(this.ipcrenderer=t.ipcRenderer)}this.isElectron&&console.info("Running on electron runtime "+this.electronVersion)}return Object.defineProperty(e.prototype,"ipcRenderer",{get:function(){return this.ipcrenderer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"isElectron",{get:function(){return void 0!==this.ipcrenderer},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"electronVersion",{get:function(){return this.isElectron?this.ipcRenderer.sendSync("get-version",""):null},enumerable:!0,configurable:!0}),e=a([n.Injectable()],e)}(),v=function(){function e(e,t){this.injector=e,this.electronService=t,console.debug("c'tor ErrorService"),this.errors=[]}var t;return t=e,e.prototype.newError=function(e,r){this.router||(this.router=this.getRouter()),this.errors.push({title:e,message:r}),console.debug("** newError"),console.debug(e+" - "+r),this.router.navigate(["/"+t.errorPage])},e.prototype.getLastError=function(){return this.errors&&this.errors.length>0?this.errors.pop():{}},e.prototype.resetApp=function(){this.electronService.isElectron?this.electronService.ipcRenderer.send("reload-app","errorService"):document.location.reload(!0)},e.prototype.handleError=function(e){console.debug("** handleError"),console.dir(e),this.newError("Anwendungsfehler",e)},e.prototype.getRouter=function(){return this.injector.get(o.Router)},e.errorPage="error",e.ctorParameters=function(){return[{type:n.Injector},{type:g}]},e=t=a([n.Injectable()],e)}(),m=function(){function e(){}return e.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("Illegal base64url string!")}return this.b64DecodeUnicode(t)},e.prototype.decodeToken=function(e){var t=e.split(".");if(3!==t.length)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");var r=this.urlBase64Decode(t[1]);if(!r)throw new Error("Cannot decode the token.");return JSON.parse(r)},e.prototype.getTokenExpirationDate=function(e){var t;if(!(t=this.decodeToken(e)).hasOwnProperty("exp"))return null;var r=new Date(0);return r.setUTCSeconds(t.exp),r},e.prototype.isTokenExpired=function(e,t){var r=this.getTokenExpirationDate(e);return t=t||0,null!==r&&!(r.valueOf()>(new Date).valueOf()+1e3*t)},e.prototype.b64decode=function(e){var t="";if((e=String(e).replace(/=+$/,"")).length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var r=0,n=void 0,o=void 0,i=0;o=e.charAt(i++);~o&&(n=r%4?64*n+o:o,r++%4)?t+=String.fromCharCode(255&n>>(-2*r&6)):0)o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(o);return t},e.prototype.b64DecodeUnicode=function(e){return decodeURIComponent(Array.prototype.map.call(this.b64decode(e),(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)})).join(""))},e=a([n.Injectable()],e)}(),b=new n.InjectionToken("LOGON_OPTIONS"),y=function(){function e(e,t,r){this.injector=t,this.jwtHelper=r,this.dontcheck=!1,this.urlswithouttoken=[],console.debug("c'tor LogonService appName="+e.appName),this.logonPar=e,this.ntlmURL=this.logonPar.NTLMserver+"?app="+this.logonPar.appName,this.loginURL=this.logonPar.webserviceServer+i.loginURL+"/",this.urlswithouttoken.push(this.ntlmURL),this.urlswithouttoken.push(this.loginURL)}var t,o;return Object.defineProperty(e.prototype,"dontCheckNow",{get:function(){return this.dontcheck},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"active",{get:function(){return"NO"!==this.logonPar.logon},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ntlm",{get:function(){return"NTLM"===this.logonPar.logon},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"urlsWithoutToken",{get:function(){return this.urlswithouttoken},enumerable:!0,configurable:!0}),e.prototype.getTokenWithCheck=function(){var e=this;return this.dontcheck?(console.debug("LogonService: wait for new token"),this.waitForToken()):this.tokenExpiresIn(30)?(console.debug("LogonService: tokenExpires - do autologin"),this.autoLogin()):new Promise((function(t,r){t(e.getToken())}))},e.prototype.autoLogin=function(){var e=this;return this.dontcheck=!0,this.httphandler||(this.httphandler=this.getHttp()),console.debug(">>> AUTO LOGIN"),console.debug(">>> 1 getting ntlm user"),this.httphandler.get(this.ntlmURL).toPromise().then((function(t){return console.debug(">>> 2 success temp-token="+t.token),console.debug(">>> 3 logging into REST API"),e.httphandler.get(e.loginURL+t.token).toPromise().then((function(t){if(console.debug(">>> 4 result jwt-token="+t.jwt),t)return e.setToken(t.jwt),e.dontcheck=!1,t.jwt;throw console.error("*** Login not successful"),e.dontcheck=!1,new Error("Login error - JWT is null")}))}))},e.prototype.getData=function(){var e,t=this.getToken();return t&&(e=this.jwtHelper.decodeToken(t)),e&&e.data||{}},e.prototype.tokenExpiresIn=function(e){var t=this.getToken();return!t||this.jwtHelper.isTokenExpired(t,e)},e.prototype.getToken=function(){var e=localStorage.getItem(i.JwtToken);return e||""},e.prototype.setToken=function(e){localStorage.setItem(i.JwtToken,e)},e.prototype.clearToken=function(){localStorage.removeItem(i.JwtToken)},e.prototype.getHttp=function(){return this.injector.get(r.HttpClient)},e.prototype.waitForToken=function(){var e=this;return new Promise((function(t){e.timeoutfn(t,10)}))},e.prototype.timeoutfn=function(e,t){var r=this;setTimeout((function(){r.dontcheck?r.timeoutfn(e,t):e(r.getToken())}),t)},e.ctorParameters=function(){return[{type:void 0,decorators:[{type:n.Inject,args:[b]}]},{type:n.Injector},{type:m}]},e=a([n.Injectable(),(t=0,o=n.Inject(b),function(e,r){o(e,r,t)})],e)}(),w=function(){function e(e,t){this.logonService=e,this.errorService=t,this.whitelist=[],console.debug("c'tor LogonInterceptor"),this.whitelist=e.urlsWithoutToken}return e.prototype.intercept=function(e,t){var r=this;if(!this.logonService.active||this.isWhitelisted(e))return e=e.clone(),this.errorHandling(e,t);var n=this.logonService.getTokenWithCheck();return s.from(n).pipe(c.mergeMap((function(n){var o;return e=e.clone({setHeaders:(o={},o[i.JwtHeader]=n,o)}),r.errorHandling(e,t)})))},e.prototype.isWhitelisted=function(e){return this.whitelist.findIndex((function(t){return e.url.startsWith(t)}))>-1},e.prototype.errorHandling=function(e,t){var n=this;return t.handle(e).pipe(c.catchError((function(t,o){return console.debug("LogonInterceptor: errorHandling "+e.url),console.dir(t),t instanceof r.HttpErrorResponse?(0===t.status?(console.debug("LogonInterceptor: network error"),n.errorService.newError("Network Error","Der Server ist nicht erreichbar.")):t.status>=400&&(console.debug("LogonInterceptor: HTTP-Error "+t.status),401===t.status||403===t.status?n.errorService.resetApp():n.errorService.newError(t.status+" - "+t.statusText,t.message||"Server liefert ungueltige Daten.")),s.EMPTY):(console.error("LogonInterceptor: unhandled exception - rethrow"),s.throwError(t))})))},e.ctorParameters=function(){return[{type:y},{type:v}]},e=a([n.Injectable()],e)}(),E=function(){function e(e,t,r){this.http=e,this.electronService=t,this.location=r}return Object.defineProperty(e.prototype,"ver",{get:function(){return this.version},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"serverVer",{get:function(){return this.serverversion},enumerable:!0,configurable:!0}),e.prototype.init=function(e){return l(this,void 0,void 0,(function(){var t,r=this;return p(this,(function(o){return t=this.location.prepareExternalUrl(""),[2,this.http.get(t+"package.json").toPromise().then((function(o){return l(r,void 0,void 0,(function(){var r,i=this;return p(this,(function(s){switch(s.label){case 0:o.versions=["Angular "+n.VERSION.full],this.electronService.isElectron&&o.versions.push("Electron "+this.electronService.electronVersion),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,this.http.get(t+"resource/git.txt",{responseType:"text"}).toPromise()];case 2:return r=s.sent(),o.githash=r.replace(/\n/,"").replace(/\r/,""),[3,4];case 3:return s.sent(),console.error("Fehler beim Lesen von ./resource/git.txt"),o.githash="",[3,4];case 4:return this.version=this.makeVer(o),e?[2,this.http.get(e).toPromise().then((function(e){return i.serverversion=i.makeVer(e),i.version})).catch((function(e){return console.error("Fehler beim Ermitteln der Server-Version: "+e),i.version}))]:[2,this.version]}}))}))}))]}))}))},e.prototype.makeVer=function(e){var t=u.prerelease(e.version),r="",n=null;return t&&t.length>0&&("number"==typeof t[0]?(n=+t[0],r="beta"):(r=t[0],n="number"==typeof t[1]?+t[1]:0)),{name:e.name,displayname:e.displayname,description:e.description,version:e.version,copyright:e.copyright,author:e.author,license:e.license,major:u.major(e.version),minor:u.minor(e.version),patch:u.patch(e.version),prerelease:r,build:n,githash:e.githash?e.githash:"",versions:e.versions}},e.ctorParameters=function(){return[{type:r.HttpClient},{type:g},{type:t.Location}]},e=a([n.Injectable()],e)}();function S(e){return e}var k=function(){function e(){}return e=a([n.NgModule({imports:[t.CommonModule],exports:[h,d,f],declarations:[h,d,f],providers:[g,v,E,y,m,{provide:r.HTTP_INTERCEPTORS,useClass:w,multi:!0},{provide:n.ErrorHandler,useFactory:S,deps:[v]}]})],e)}(),P=function(){function e(){}return e.load=function(e){var t=this;return new Promise((function(r,n){var o=new XMLHttpRequest;o.overrideMimeType("application/json"),o.open("GET",e,!0),o.onreadystatechange=function(){4===o.readyState&&(200===o.status?(t.settings=JSON.parse(o.responseText),r()):n("Could not load file '"+e+"': "+o.status))},o.send()}))},e.settings={},e=a([n.Injectable()],e)}(),T=function(){function e(e,t){var r=this,n=i.makeSseUrl("farc");this.sse=new EventSource(e+n,{withCredentials:!0}),this.sse.onopen=function(e){console.debug("SSE open readystate="+r.sse.readyState)},this.addEventListener("init",(function(e){console.debug("SSE received initialization message")})),this.sse.onerror=function(e){console.error("EventSource failed. "),console.dir(e)}}return e.prototype.addEventListener=function(e,t){console.debug("SSE addEventListener "+e),this.sse.addEventListener(e,t)},e.prototype.removeEventListener=function(e,t){this.sse.removeEventListener(e,t)},e}();e.AppConfig=P,e.ElectronService=g,e.ErrorService=v,e.FileSizePipe=d,e.FlexboxSplitter=h,e.IEDatePipe=f,e.JwtHelperService=m,e.LOGON_OPTIONS=b,e.LibClientModule=k,e.LogonInterceptor=w,e.LogonService=y,e.SseHandler=T,e.VersionService=E,e.ɵa=S,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=hb42-lib-client.umd.min.js.map