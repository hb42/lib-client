!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/router"),require("@angular/common"),require("semver"),require("@angular/common/http"),require("@hb42/lib-common"),require("rxjs"),require("rxjs/operators"),require("@angular/core")):"function"==typeof define&&define.amd?define("@hb42/lib-client",["exports","@angular/router","@angular/common","semver","@angular/common/http","@hb42/lib-common","rxjs","rxjs/operators","@angular/core"],t):t((e.hb42=e.hb42||{},e.hb42["lib-client"]={}),e.ng.router,e.ng.common,e.semver,e.ng.common.http,e["@hb42/lib-common"],e.rxjs,e.rxjs.operators,e.ng.core)}(this,function(e,t,r,n,i,s,c,a,u){"use strict";var o=(l.prototype.ngOnInit=function(){this.prevEl=this.splitter.previousElementSibling,this.nextEl=this.splitter.nextElementSibling;var e=this.splitter.parentElement;"row"===this.getProp(e,"flexDirection")?(this.dimension="width",this.splitter.style["border-left"]="1px solid gray",this.splitter.style.cursor="col-resize"):(this.dimension="height",this.splitter.style["border-top"]="1px solid gray",this.splitter.style.cursor="row-resize"),this.splitter.style.background="#eee",this.splitter.style[this.dimension]="6px",this.initSplitter()},l.prototype.getProp=function(e,t){return window.getComputedStyle(e)[t]},l.prototype.initSplitter=function(){var o=this,e={bubbles:!1,cancelable:!1,detail:undefined};function t(e){"width"===o.dimension?r(e.clientX):r(e.clientY)}this.splitterEvent=document.createEvent("CustomEvent"),this.splitterEvent.initCustomEvent(l.SPLITTER_EVENT,e.bubbles,e.cancelable,e.detail);var r=function(e){var t,r=e-o.lastPos;t=parseInt(o.getProp(o.prevEl,o.dimension),10)+r,o.prevEl.style[o.dimension]=t+"px",t=parseInt(o.getProp(o.nextEl,o.dimension),10)-r,o.nextEl.style[o.dimension]=t+"px",o.lastPos=e},n=function(){window.removeEventListener("mousemove",t),window.removeEventListener("mouseup",n),window.dispatchEvent(o.splitterEvent),o.storageId&&localStorage.setItem(o.storageId,o.lastPos.toString(10))};if(this.splitter.addEventListener("mousedown",function(e){e.preventDefault(),o.lastPos="width"===o.dimension?e.clientX:e.clientY,window.addEventListener("mousemove",t),window.addEventListener("mouseup",n)}),this.lastPos="width"===this.dimension?this.splitter.getBoundingClientRect().left:this.splitter.getBoundingClientRect().top,this.storageId){var i=localStorage.getItem(this.storageId),s=parseInt(i||"0",10);s&&r(s)}},l.SPLITTER_EVENT="hbsplitter",l.decorators=[{type:u.Directive,args:[{selector:"[fb-splitter]"}]}],l.ctorParameters=function(){return[{type:u.ElementRef}]},l.propDecorators={storageId:[{type:u.Input}]},l);function l(e){this.el=e,this.storageId="",this.lastPos=0,console.debug("c'tor flexboxsplitter"),this.splitter=e.nativeElement}var p=(h.prototype.transform=function(e){var t=Number(e);return this.conv(t,0)},h.prototype.conv=function(e,t){return e<1024?e+" "+this.suffix[t]:this.conv(Math.round(e/1024),++t)},h.decorators=[{type:u.Pipe,args:[{name:"filesize"}]}],h.ctorParameters=function(){return[]},h);function h(){this.suffix=["Bytes","kB","MB","GB","TB","PB","EB","ZB","YB"]}var d=(f.prototype.transform=function(e){var t=new Date(e);return t.toLocaleDateString("de",{day:"2-digit",month:"2-digit",year:"numeric"})+" "+t.toLocaleTimeString()},f.decorators=[{type:u.Pipe,args:[{name:"iedate"}]}],f);function f(){}var g=(Object.defineProperty(v.prototype,"ipcRenderer",{get:function(){return this.ipcrenderer},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"isElectron",{get:function(){return"undefined"!=typeof this.ipcrenderer},enumerable:!0,configurable:!0}),Object.defineProperty(v.prototype,"electronVersion",{get:function(){return this.isElectron?this.ipcRenderer.sendSync("get-version",""):null},enumerable:!0,configurable:!0}),v.decorators=[{type:u.Injectable}],v.ctorParameters=function(){return[]},v);function v(){var e=window;if("function"==typeof e.require){var t=e.require("electron");t&&(this.ipcrenderer=t.ipcRenderer)}this.isElectron&&console.info("Running on electron runtime "+this.electronVersion)}var m=(y.prototype.newError=function(e,t){this.router||(this.router=this.getRouter()),this.errors.push({title:e,message:t}),console.debug("** newError"),console.debug(e+" - "+t),this.router.navigate(["/"+y.errorPage])},y.prototype.getLastError=function(){return this.errors&&0<this.errors.length?this.errors.pop():{}},y.prototype.resetApp=function(){this.electronService.isElectron?this.electronService.ipcRenderer.send("reload-app","errorService"):document.location.reload(!0)},y.prototype.handleError=function(e){console.debug("** handleError"),console.dir(e),this.newError("Anwendungsfehler",e)},y.prototype.getRouter=function(){return this.injector.get(t.Router)},y.errorPage="error",y.decorators=[{type:u.Injectable}],y.ctorParameters=function(){return[{type:u.Injector},{type:g}]},y);function y(e,t){this.injector=e,this.electronService=t,console.debug("c'tor ErrorService"),this.errors=[]}var b=this&&this.__awaiter||function(t,s,c,a){return new(c||(c=Promise))(function(e,r){function o(e){try{i(a.next(e))}catch(t){r(t)}}function n(e){try{i(a["throw"](e))}catch(t){r(t)}}function i(t){t.done?e(t.value):new c(function(e){e(t.value)}).then(o,n)}i((a=a.apply(t,s||[])).next())})},w=this&&this.__generator||function(o,n){var i,s,c,e,a={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return e={next:t(0),"throw":t(1),"return":t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function r(e){if(i)throw new TypeError("Generator is already executing.");for(;a;)try{if(i=1,s&&(c=2&e[0]?s["return"]:e[0]?s["throw"]||((c=s["return"])&&c.call(s),0):s.next)&&!(c=c.call(s,e[1])).done)return c;switch(s=0,c&&(e=[2&e[0],c.value]),e[0]){case 0:case 1:c=e;break;case 4:return a.label++,{value:e[1],done:!1};case 5:a.label++,s=e[1],e=[0];continue;case 7:e=a.ops.pop(),a.trys.pop();continue;default:if(!(c=0<(c=a.trys).length&&c[c.length-1])&&(6===e[0]||2===e[0])){a=0;continue}if(3===e[0]&&(!c||e[1]>c[0]&&e[1]<c[3])){a.label=e[1];break}if(6===e[0]&&a.label<c[1]){a.label=c[1],c=e;break}if(c&&a.label<c[2]){a.label=c[2],a.ops.push(e);break}c[2]&&a.ops.pop(),a.trys.pop();continue}e=n.call(o,a)}catch(t){e=[6,t],s=0}finally{i=c=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([t,e])}}},E=(Object.defineProperty(S.prototype,"ver",{get:function(){return this.version},enumerable:!0,configurable:!0}),Object.defineProperty(S.prototype,"serverVer",{get:function(){return this.serverversion},enumerable:!0,configurable:!0}),S.prototype.init=function(i){return b(this,void 0,void 0,function(){var n,t=this;return w(this,function(e){return n=this.location.prepareExternalUrl(""),[2,this.http.get(n+"package.json").toPromise().then(function(o){return b(t,void 0,void 0,function(){var t,r=this;return w(this,function(e){switch(e.label){case 0:o.versions=["Angular "+u.VERSION.full],this.electronService.isElectron&&o.versions.push("Electron "+this.electronService.electronVersion),e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this.http.get(n+"resource/git.txt",{responseType:"text"}).toPromise()];case 2:return t=e.sent(),o.githash=t.replace(/\n/,"").replace(/\r/,""),[3,4];case 3:return e.sent(),console.error("Fehler beim Lesen von ./resource/git.txt"),o.githash="",[3,4];case 4:return this.version=this.makeVer(o),i?[2,this.http.get(i).toPromise().then(function(e){return r.serverversion=r.makeVer(e),r.version})["catch"](function(e){return console.error("Fehler beim Ermitteln der Server-Version: "+e),r.version})]:[2,this.version]}})})})]})})},S.prototype.makeVer=function(e){var t=n.prerelease(e.version),r="",o=null;return t&&0<t.length&&("number"==typeof t[0]?(o=+t[0],r="beta"):(r=t[0],o="number"==typeof t[1]?+t[1]:0)),{name:e.name,displayname:e.displayname,description:e.description,version:e.version,copyright:e.copyright,author:e.author,license:e.license,major:n.major(e.version),minor:n.minor(e.version),patch:n.patch(e.version),prerelease:r,build:o,githash:e.githash?e.githash:"",versions:e.versions}},S.decorators=[{type:u.Injectable}],S.ctorParameters=function(){return[{type:i.HttpClient},{type:g},{type:r.Location}]},S);function S(e,t,r){this.http=e,this.electronService=t,this.location=r}var k=(P.prototype.addEventListener=function(e,t){console.debug("SSE addEventListener "+e),this.sse.addEventListener(e,t)},P.prototype.removeEventListener=function(e,t){this.sse.removeEventListener(e,t)},P);function P(e,t){var r=this,o=s.makeSseUrl("farc");this.sse=new EventSource(e+o,{withCredentials:!0}),this.sse.onopen=function(e){console.debug("SSE open readystate="+r.sse.readyState)},this.addEventListener("init",function(e){console.debug("SSE received initialization message")}),this.sse.onerror=function(e){console.error("EventSource failed. "),console.dir(e)}}var T=(x.prototype.urlBase64Decode=function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("Illegal base64url string!")}return this.b64DecodeUnicode(t)},x.prototype.decodeToken=function(e){var t=e.split(".");if(3!==t.length)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");var r=this.urlBase64Decode(t[1]);if(!r)throw new Error("Cannot decode the token.");return JSON.parse(r)},x.prototype.getTokenExpirationDate=function(e){var t;if(!(t=this.decodeToken(e)).hasOwnProperty("exp"))return null;var r=new Date(0);return r.setUTCSeconds(t.exp),r},x.prototype.isTokenExpired=function(e,t){var r=this.getTokenExpirationDate(e);return t=t||0,null!==r&&!(r.valueOf()>(new Date).valueOf()+1e3*t)},x.prototype.b64decode=function(e){var t="";if((e=String(e).replace(/=+$/,"")).length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var r=0,o=void 0,n=void 0,i=0;n=e.charAt(i++);~n&&(o=r%4?64*o+n:n,r++%4)?t+=String.fromCharCode(255&o>>(-2*r&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return t},x.prototype.b64DecodeUnicode=function(e){return decodeURIComponent(Array.prototype.map.call(this.b64decode(e),function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))},x.decorators=[{type:u.Injectable}],x);function x(){}var I=new u.InjectionToken("LOGON_OPTIONS"),L=(Object.defineProperty(j.prototype,"dontCheckNow",{get:function(){return this.dontcheck},enumerable:!0,configurable:!0}),Object.defineProperty(j.prototype,"active",{get:function(){return"NO"!==this.logonPar.logon},enumerable:!0,configurable:!0}),Object.defineProperty(j.prototype,"ntlm",{get:function(){return"NTLM"===this.logonPar.logon},enumerable:!0,configurable:!0}),Object.defineProperty(j.prototype,"urlsWithoutToken",{get:function(){return this.urlswithouttoken},enumerable:!0,configurable:!0}),j.prototype.getTokenWithCheck=function(){var r=this;return this.dontcheck?(console.debug("LogonService: wait for new token"),this.waitForToken()):this.tokenExpiresIn(30)?(console.debug("LogonService: tokenExpires - do autologin"),this.autoLogin()):new Promise(function(e,t){e(r.getToken())})},j.prototype.autoLogin=function(){var t=this;return this.dontcheck=!0,this.httphandler||(this.httphandler=this.getHttp()),console.debug(">>> AUTO LOGIN"),console.debug(">>> 1 getting ntlm user"),this.httphandler.get(this.ntlmURL).toPromise().then(function(e){return console.debug(">>> 2 success temp-token="+e.token),console.debug(">>> 3 logging into REST API"),t.httphandler.get(t.loginURL+e.token).toPromise().then(function(e){if(console.debug(">>> 4 result jwt-token="+e.jwt),e)return t.setToken(e.jwt),t.dontcheck=!1,e.jwt;throw console.error("*** Login not successful"),t.dontcheck=!1,new Error("Login error - JWT is null")})})},j.prototype.getData=function(){var e,t=this.getToken();return t&&(e=this.jwtHelper.decodeToken(t)),e&&e.data||{}},j.prototype.tokenExpiresIn=function(e){var t=this.getToken();return!t||this.jwtHelper.isTokenExpired(t,e)},j.prototype.getToken=function(){var e=localStorage.getItem(s.JwtToken);return e||""},j.prototype.setToken=function(e){localStorage.setItem(s.JwtToken,e)},j.prototype.clearToken=function(){localStorage.removeItem(s.JwtToken)},j.prototype.getHttp=function(){return this.injector.get(i.HttpClient)},j.prototype.waitForToken=function(){var t=this;return new Promise(function(e){t.timeoutfn(e,10)})},j.prototype.timeoutfn=function(e,t){var r=this;setTimeout(function(){r.dontcheck?r.timeoutfn(e,t):e(r.getToken())},t)},j.decorators=[{type:u.Injectable}],j.ctorParameters=function(){return[{type:undefined,decorators:[{type:u.Inject,args:[I]}]},{type:u.Injector},{type:T}]},j);function j(e,t,r){this.injector=t,this.jwtHelper=r,this.dontcheck=!1,this.urlswithouttoken=[],console.debug("c'tor LogonService appName="+e.appName),this.logonPar=e,this.ntlmURL=this.logonPar.NTLMserver+"?app="+this.logonPar.appName,this.loginURL=this.logonPar.webserviceServer+s.loginURL+"/",this.urlswithouttoken.push(this.ntlmURL),this.urlswithouttoken.push(this.loginURL)}var O=(R.prototype.intercept=function(r,o){var n=this;if(!this.logonService.active||this.isWhitelisted(r))return r=r.clone(),this.errorHandling(r,o);var e=this.logonService.getTokenWithCheck();return c.from(e).pipe(a.mergeMap(function(e){var t;return r=r.clone({setHeaders:(t={},t[s.JwtHeader]=e,t)}),n.errorHandling(r,o)}))},R.prototype.isWhitelisted=function(t){return-1<this.whitelist.findIndex(function(e){return t.url.startsWith(e)})},R.prototype.errorHandling=function(r,e){var o=this;return e.handle(r).pipe(a.catchError(function(e,t){return console.debug("LogonInterceptor: errorHandling "+r.url),console.dir(e),e instanceof i.HttpErrorResponse?(0===e.status?(console.debug("LogonInterceptor: network error"),o.errorService.newError("Network Error","Der Server ist nicht erreichbar.")):400<=e.status&&(console.debug("LogonInterceptor: HTTP-Error "+e.status),401===e.status||403===e.status?o.errorService.resetApp():o.errorService.newError(e.status+" - "+e.statusText,e.message||"Server liefert ungueltige Daten.")),c.EMPTY):(console.error("LogonInterceptor: unhandled exception - rethrow"),c.throwError(e))}))},R.decorators=[{type:u.Injectable}],R.ctorParameters=function(){return[{type:L},{type:m}]},R);function R(e,t){this.logonService=e,this.errorService=t,this.whitelist=[],console.debug("c'tor LogonInterceptor"),this.whitelist=e.urlsWithoutToken}var C=(N.load=function(o){var n=this;return new Promise(function(e,t){var r=new XMLHttpRequest;r.overrideMimeType("application/json"),r.open("GET",o,!0),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?(n.settings=JSON.parse(r.responseText),e()):t("Could not load file '"+o+"': "+r.status))},r.send()})},N.settings={},N.decorators=[{type:u.Injectable}],N);function N(){}function H(e){return e}var D=(U.decorators=[{type:u.NgModule,args:[{imports:[r.CommonModule],exports:[o,p,d],declarations:[o,p,d],providers:[g,m,E,L,T,{provide:i.HTTP_INTERCEPTORS,useClass:O,multi:!0},{provide:u.ErrorHandler,useFactory:H,deps:[m]}]}]}],U);function U(){}e.LibClientModule=D,e.ElectronService=g,e.ErrorService=m,e.VersionService=E,e.SseHandler=k,e.JwtHelperService=T,e.LogonService=L,e.LogonInterceptor=O,e.LOGON_OPTIONS=I,e.AppConfig=C,e.FlexboxSplitter=o,e.FileSizePipe=p,e.IEDatePipe=d,e.ɵb=o,e.ɵa=H,e.ɵc=p,e.ɵd=d,e.ɵf=T,e.ɵg=O,e.ɵe=L,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=hb42-lib-client.umd.min.js.map